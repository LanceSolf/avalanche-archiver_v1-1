<!DOCTYPE html>
<html>

<head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" />

    <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #main_map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .leaflet-container {
            font-size: 1rem;
        }
    </style>

    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
</head>

<body>
    <div id="main_map"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Parse URL Parameters
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lon = parseFloat(urlParams.get('lon'));
            const profileId = urlParams.get('profileId');
            const incLat = parseFloat(urlParams.get('incLat'));
            const incLon = parseFloat(urlParams.get('incLon'));
            const incId = urlParams.get('incId');
            const incFilename = urlParams.get('incFilename');
            const context = urlParams.get('context');
            const locationName = urlParams.get('location');
            const customTitle = urlParams.get('title');
            const linkUrl = urlParams.get('linkUrl');
            const linkText = urlParams.get('linkText') || 'View Details';

            // 2. Determine Initial View
            let startCenter = [47.4099, 10.2797]; // Default Allgäu
            let startZoom = 10;

            if (!isNaN(lat) && !isNaN(lon)) {
                startCenter = [lat, lon];
                startZoom = 15;
            } else if (!isNaN(incLat) && !isNaN(incLon)) {
                startCenter = [incLat, incLon];
                startZoom = 15;
            }

            // 3. Initialize Map
            // Expose globally as 'map' for external scripts (buildProfilePages.js compatibility)
            // Note: We use 'var' or attach to window explicitly for global scope compatibility
            window.map = L.map("main_map", {
                center: startCenter,
                zoom: startZoom,
                crs: L.CRS.EPSG3857,
                zoomControl: true,
                preferCanvas: false
            });

            // 4. Define Tile Layers
            const osmLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
                minZoom: 0,
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            const topoLayer = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
                minZoom: 0,
                maxZoom: 17,
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            });

            // 5. Dynamic Layer Switching
            function updateLayers() {
                const zoom = window.map.getZoom();
                if (zoom < 13) {
                    if (window.map.hasLayer(topoLayer)) window.map.removeLayer(topoLayer);
                    if (!window.map.hasLayer(osmLayer)) window.map.addLayer(osmLayer);
                } else {
                    if (window.map.hasLayer(osmLayer)) window.map.removeLayer(osmLayer);
                    if (!window.map.hasLayer(topoLayer)) window.map.addLayer(topoLayer);
                }
            }

            window.map.on('zoomend', updateLayers);
            updateLayers(); // Initial set

            // 6. Add Dynamic Markers (Incident / Profile)
            const points = [];
            let profileMarker, incidentMarker;

            // Title Logic
            let profileTitle = customTitle;
            if (!profileTitle) {
                if (context === 'coords') {
                    profileTitle = 'Relevant Profile';
                } else if (incId) {
                    profileTitle = 'Selected Profile';
                } else {
                    profileTitle = locationName || 'Selected Profile';
                }
            }
            const incidentTitle = (context === 'coords') ? 'Selected Incident' : 'Avalanche Incident';

            // Add Profile Marker
            if (!isNaN(lat) && !isNaN(lon)) {
                const mapBackUrl = 'map.html' + window.location.search;
                const backParam = `?back=${encodeURIComponent(mapBackUrl)}`;

                let popup = `<b>${profileTitle}</b>`;
                if (profileId) {
                    popup += `<br><a href="${profileId}.html${backParam}" target="_parent" style="color:#0284c7; font-weight:bold;">View Profile →</a>`;
                } else if (linkUrl) {
                    popup += `<br><a href="${linkUrl}" target="_parent" style="color:#0284c7; font-weight:bold;">${linkText} →</a>`;
                }

                const profileIcon = L.divIcon({
                    className: 'profile-marker',
                    html: '<div style="background:#0284c7; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                profileMarker = L.marker([lat, lon], { icon: profileIcon }).addTo(window.map);
                profileMarker.bindPopup(popup);
                points.push([lat, lon]);
            }

            // Add Incident Marker
            if (!isNaN(incLat) && !isNaN(incLon)) {
                const incidentIcon = L.divIcon({
                    className: 'incident-marker',
                    html: '<div style="background:#ef4444; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const href = incFilename
                    ? `../incidents/${incFilename}`
                    : incId ? `../incidents/index.html` : '';

                const popupContent = href
                    ? `<b>${incidentTitle}</b><br><a href="${href}" style="color:#ef4444; font-weight:bold;">View Incident →</a>`
                    : `<b>${incidentTitle}</b>`;

                incidentMarker = L.marker([incLat, incLon], { icon: incidentIcon }).addTo(window.map)
                    .bindPopup(popupContent);
                points.push([incLat, incLon]);
            }

            // Open appropriate popup
            if (context === 'coords' && incidentMarker) {
                incidentMarker.openPopup();
            } else if (profileMarker) {
                profileMarker.openPopup();
            } else if (incidentMarker) {
                incidentMarker.openPopup();
            }
        });
    </script>

        <script>
            document.addEventListener("DOMContentLoaded", function() {
                setTimeout(() => {
                    let map;
                    for (let key in window) {
                         if (window[key] instanceof L.Map) { map = window[key]; break; }
                    }
                    if (!map) return;
                    
                    // Remove existing static CircleMarkers immediately to prevent flashing
                    map.eachLayer(layer => {
                        if (layer instanceof L.CircleMarker) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    // Add Recent Profiles (Strictly Recent Only)
                    const profiles = [{"profil_id":24620,"datum":"2026-01-21 13:20:00","country_id":1,"region_id":1,"subregion_id":164,"ort":"Kälberlangzugjoch","seehoehe":2450,"latitude":47.20056,"longitude":10.34711,"hangneigung":25,"exposition_id":1,"loggedon":"2026-01-22 08:52:29","revision":1,"location":"Kälberlangzugjoch","elevation":2450,"slope":25,"neigung":25,"aspect":1,"exposition":1,"comments":"ECTN 20@69.0cm: Teilbruch (N)\nECTN 5@80.0cm: Teilbruch (N)\nECTN 21@69.0cm: Teilbruch (N)","comments_en":"ECTN 20@69.0cm: Partial fraction (N)\nECTN 5@80.0cm: partial fraction (N)\nECTN 21@69.0cm: Partial fraction (N)","stability_tests":[{"type":{"text":"ECT"},"step":20,"height":69,"result":{"text":"no propagation (N)"}},{"type":{"text":"ECT"},"step":5,"height":80,"result":{"text":"no propagation (N)"}},{"type":{"text":"ECT"},"step":21,"height":69,"result":{"text":"no propagation (N)"}}]},{"profil_id":24618,"datum":"2026-01-21 12:30:00","country_id":1,"region_id":1,"subregion_id":164,"ort":"Kälberlangzugjoch","seehoehe":2440,"latitude":47.20006,"longitude":10.34862,"hangneigung":38,"exposition_id":5,"loggedon":"2026-01-22 07:43:56","revision":4,"location":"Kälberlangzugjoch","elevation":2440,"slope":38,"neigung":38,"aspect":5,"exposition":5,"comments":"ECTN 5@34.0cm: Teilbruch (N)","comments_en":"ECTN 5@34.0cm: Partial fraction (N)","stability_tests":[{"type":{"text":"ECT"},"step":5,"height":34,"result":{"text":"no propagation (N)"}}]},{"profil_id":24619,"datum":"2026-01-21 11:30:00","country_id":1,"region_id":1,"subregion_id":164,"ort":"Kälberlangzug","seehoehe":2300,"latitude":47.19586,"longitude":10.34957,"hangneigung":29,"exposition_id":3,"loggedon":"2026-01-22 08:03:56","revision":2,"location":"Kälberlangzug","elevation":2300,"slope":29,"neigung":29,"aspect":3,"exposition":3,"comments":"#SNP-FC\nECTN 14@69.0cm: Teilbruch (N)\nECTN 12@83.0cm: Teilbruch (N)\nECTP 15@69.0cm: plötzlicher Bruch (P) (ganzer Block)\norographisch rechts von relativ frischer Lawine","comments_en":"#SNP-FC\nECTN 14@69.0cm: Partial fracture (N)\nECTN 12@83.0cm: Partial fracture (N)\nECTP 15@69.0cm: Sudden fracture (P) (entire block)\norographically to the right of a relatively recent avalanche","stability_tests":[{"type":{"text":"ECT"},"step":14,"height":69,"result":{"text":"no propagation (N)"}},{"type":{"text":"ECT"},"step":12,"height":83,"result":{"text":"no propagation (N)"}},{"type":{"text":"ECT"},"step":15,"height":69,"result":{"text":"propagation (P)"}}]},{"profil_id":24410,"ort":"Riezlern","datum":"2026-01-12 10:45:00","seehoehe":1800,"exposition":1,"neigung":35,"region":"Archived","latitude":47.35351,"longitude":10.11609}];
                    profiles.forEach(p => {
                        if (p.latitude && p.longitude) {
                            // Differentiate user uploads with Orange (#f97316), matching the UI button
                            const isUser = p.isUserUpload; 
                            const color = isUser ? "#f97316" : "#0284c7";
                            
                            const marker = L.circleMarker([p.latitude, p.longitude], {
                                color: color, fillColor: color, fillOpacity: 0.7, radius: isUser ? 9 : 8, weight: 2
                            }).addTo(map);
                            const backParam = window.location.search; // Pass current context if any
                            marker.bindPopup(`<b>${p.ort}</b><br><span style="font-size:0.8rem">${p.datum}</span><br><a href="${p.profil_id || p.id}.html${backParam}" target="_top" style="color:${color}; font-weight:bold;">View Profile →</a>`);
                        }
                    });
                }, 0); // Run immediately to avoid flash
            });
        </script></body>

</html>