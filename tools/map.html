<!DOCTYPE html>
<html>

<head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" />

    <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #main_map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .leaflet-container {
            font-size: 1rem;
        }
    </style>

    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
</head>

<body>
    <div id="main_map"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Parse URL Parameters
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get('lat'));
            const lon = parseFloat(urlParams.get('lon'));
            const profileId = urlParams.get('profileId');
            const incLat = parseFloat(urlParams.get('incLat'));
            const incLon = parseFloat(urlParams.get('incLon'));
            const incId = urlParams.get('incId');
            const incFilename = urlParams.get('incFilename');
            const context = urlParams.get('context');
            const locationName = urlParams.get('location');
            const customTitle = urlParams.get('title');
            const linkUrl = urlParams.get('linkUrl');
            const linkText = urlParams.get('linkText') || 'View Details';

            // 2. Determine Initial View
            let startCenter = [47.4099, 10.2797]; // Default Allgäu
            let startZoom = 10;

            if (!isNaN(lat) && !isNaN(lon)) {
                startCenter = [lat, lon];
                startZoom = 15;
            } else if (!isNaN(incLat) && !isNaN(incLon)) {
                startCenter = [incLat, incLon];
                startZoom = 15;
            }

            // 3. Initialize Map
            // Expose globally as 'map' for external scripts (buildProfilePages.js compatibility)
            // Note: We use 'var' or attach to window explicitly for global scope compatibility
            window.map = L.map("main_map", {
                center: startCenter,
                zoom: startZoom,
                crs: L.CRS.EPSG3857,
                zoomControl: true,
                preferCanvas: false
            });

            // 4. Define Tile Layers
            const osmLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
                minZoom: 0,
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            const topoLayer = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
                minZoom: 0,
                maxZoom: 17,
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            });

            // 5. Dynamic Layer Switching
            function updateLayers() {
                const zoom = window.map.getZoom();
                if (zoom < 13) {
                    if (window.map.hasLayer(topoLayer)) window.map.removeLayer(topoLayer);
                    if (!window.map.hasLayer(osmLayer)) window.map.addLayer(osmLayer);
                } else {
                    if (window.map.hasLayer(osmLayer)) window.map.removeLayer(osmLayer);
                    if (!window.map.hasLayer(topoLayer)) window.map.addLayer(topoLayer);
                }
            }

            window.map.on('zoomend', updateLayers);
            updateLayers(); // Initial set

            // 6. Add Dynamic Markers (Incident / Profile)
            const points = [];
            let profileMarker, incidentMarker;

            // Title Logic
            let profileTitle = customTitle;
            if (!profileTitle) {
                if (context === 'coords') {
                    profileTitle = 'Relevant Profile';
                } else if (incId) {
                    profileTitle = 'Selected Profile';
                } else {
                    profileTitle = locationName || 'Selected Profile';
                }
            }
            const incidentTitle = (context === 'coords') ? 'Selected Incident' : 'Avalanche Incident';

            // Add Profile Marker
            if (!isNaN(lat) && !isNaN(lon)) {
                const mapBackUrl = 'map.html' + window.location.search;
                const backParam = `?back=${encodeURIComponent(mapBackUrl)}`;

                let popup = `<b>${profileTitle}</b>`;
                if (profileId) {
                    popup += `<br><a href="${profileId}.html${backParam}" target="_parent" style="color:#0284c7; font-weight:bold;">View Profile →</a>`;
                } else if (linkUrl) {
                    popup += `<br><a href="${linkUrl}" target="_parent" style="color:#0284c7; font-weight:bold;">${linkText} →</a>`;
                }

                const profileIcon = L.divIcon({
                    className: 'profile-marker',
                    html: '<div style="background:#0284c7; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                profileMarker = L.marker([lat, lon], { icon: profileIcon }).addTo(window.map);
                profileMarker.bindPopup(popup);
                points.push([lat, lon]);
            }

            // Add Incident Marker
            if (!isNaN(incLat) && !isNaN(incLon)) {
                const incidentIcon = L.divIcon({
                    className: 'incident-marker',
                    html: '<div style="background:#ef4444; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const href = incFilename
                    ? `../incidents/${incFilename}`
                    : incId ? `../incidents/index.html` : '';

                const popupContent = href
                    ? `<b>${incidentTitle}</b><br><a href="${href}" style="color:#ef4444; font-weight:bold;">View Incident →</a>`
                    : `<b>${incidentTitle}</b>`;

                incidentMarker = L.marker([incLat, incLon], { icon: incidentIcon }).addTo(window.map)
                    .bindPopup(popupContent);
                points.push([incLat, incLon]);
            }

            // Open appropriate popup
            if (context === 'coords' && incidentMarker) {
                incidentMarker.openPopup();
            } else if (profileMarker) {
                profileMarker.openPopup();
            } else if (incidentMarker) {
                incidentMarker.openPopup();
            }
        });
    </script>
</body>

</html>